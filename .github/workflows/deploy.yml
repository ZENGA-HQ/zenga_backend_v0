name: Deploy to Dokploy

on: 
  push: 
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Dokploy
        env:
          DOKPLOY_WEBHOOK_URL: ${{ secrets.DOKPLOY_WEBHOOK_URL }}
        run: |
          echo "ðŸš€ Triggering deployment..."
          echo "ðŸ“ Branch: ${GITHUB_REF_NAME}"
          echo "ðŸ” Webhook URL length: ${#DOKPLOY_WEBHOOK_URL}"
          
          # Debug: Show first/last chars of URL (without exposing full URL)
          echo "ðŸ” URL starts with: $(echo ${DOKPLOY_WEBHOOK_URL} | cut -c1-30)..."
          
          # Try with verbose to see what's happening
          response=$(curl -v -L -X POST "${DOKPLOY_WEBHOOK_URL}" 2>&1)
          
          echo "Full response:"
          echo "$response"
          
          # Extract actual response
          http_code=$(echo "$response" | grep -o "< HTTP.*" | tail -1 | awk '{print $3}')
          
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ]; then
            echo "âŒ DEPLOYMENT FAILED - Status: $http_code"
            exit 1
          fi
          
          echo "âœ… Deployment triggered successfully"
